<!doctype html><html><head><meta name=generator content="Hugo 0.111.1"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="some guy's technology blog"><meta name=Author content="Daelon Suzuka"><meta name=keywords content="hugo blog"><link rel=stylesheet href=https://daelon.net/css/syntax.css><link rel=stylesheet href=https://daelon.net/css/style.css><title>daelon.net</title><meta property="og:title" content><meta property="og:description" content="some guy's technology blog"><meta property="og:type" content="website"><meta property="og:url" content="https://daelon.net/"><meta property="og:image" content="https://daelon.net/og_preview.png"><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><meta name=theme-color content="#ffffff"><script defer data-domain=daelon.net src=https://plausible.daelon.net/js/script.js></script></head><body><aside id=sidenav><header><a id=branding href=https://daelon.net/><svg id="avatar" href="https://daelon.net"/></svg><script>var quotes=[["I thought what I'd do was I'd pretend I was one of those deaf-mutes",28],["Technology is a word that describes something that doesnâ€™t work yet",27],["People who are really serious about software should make their own hardware",23]];function create_svg(){var e=Math.floor(Math.random()*quotes.length),t=quotes[e][1],n=quotes[e][0],s=`<svg viewBox="-180 -180 380 360" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <path id="f" d="m123,0a123,123 0,0 1-246,0a123,123 0,0 1 246,0"/>
            <g fill="#2A7DAE">
                <circle r="160"/>
                <circle r="150" fill="#fff"/>
                
            <text font-size="${t}" font-stretch="condensed" font-family="Impact">
                <animateTransform type="rotate" from="360 0 0" to="0 0 0" dur="20s" attributeName="transform" repeatCount="indefinite"/>
                <textPath xlink:href="#f">
                    ${n}
                </textPath>
            </text>
            
            <circle r="115"/>
            <circle r="95" fill="#fff"/>
            <path d="m-8-119h16 l2,5h-20z"/>
            <circle cx="160" cy="0" r="40"/>
            <path d="m-95-20v-20h255a40,40 0,0 1 0,80h-55v-20z"/>
            <path d="m-85 0a85,85 0,0 0 170,0h-20a65,65 0,0 1-130,0z"/>
            <path d="m-65 20v20h140v-20z"/>
            <path d="m-115-20v10h25v30h250a20,20 0,0 0 0,-40z" fill="#fff"/>
            <path d="m-20 10c-17-14-27-14-44 0 6-25 37-25 44 0z"/>
            <path d="m60 10c-17-14-27-14-44 0 6-25 37-25 44 0z"/>
            </g>
        </svg>`;return s}document.getElementById("avatar").innerHTML=create_svg()</script></a></header><nav><a href=/><span>home</span></a>
<a href=/posts/><span>posts</span></a>
<a href=/gamedev><span>gamedev</span></a>
<a href=/projects><span>projects</span></a>
<a href=/scripts><span>scripts</span></a>
<a href=/cool_stuff><span>cool stuff</span></a>
<a href=https://github.com/DaelonSuzuka target=_blank><span>github</span></a>
<a href=/about><span>about</span></a></nav></aside><main id=main><a href=javascript:void(0) id=closebtn onclick=navToggle()><i class="fas fa-bars fa-lg"></i></a><div class=content><div class=section><div><div class=post><div class=post-title><h1><a href=/posts/codegen1/>Code Generation Case Study: Firmware Configuration</a></h1><div class="meta post-footer">Apr 6 2024 05:09 UTC-04</div></div><div class=post-content><p>This article is part 1 in a series exploring code generation systems.</p><ol><li>Case Study: Firmware Configuration</li><li>Case Study: Message Decoding (coming soon)</li></ol><p>Configuration management in embedded systems is a difficult problem. The projects are often resource contrained, and the languages and tools are&mldr; not usually modern. It&rsquo;s rather common to have a series of products built on a common platform (same microcontroller(MCU), shared libraries), but different hardware configurations. Sharing code between projects is a valuable time/effort saver, but it&rsquo;s non-trivial to correctly abstract away model-specific details like the exact layout of the MCU&rsquo;s pins.</p><h2 id=the-status-quo>The status quo</h2><p>Here are some snippets from a real project. This is the section of code that defines human readable names for specific pins:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// hardware.h
</span></span></span><span style=display:flex><span><span style=color:#75715e>// Pin Definitions - latX for outputs, portX for inputs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Front Panel bitbang SPI
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define CLOCK_PIN           LATAbits.LATA6    </span><span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define DATA_PIN            LATAbits.LATA7    </span><span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define STROBE_PIN          LATAbits.LATA3    </span><span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Front Panel LEDs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define ANT_LED             LATAbits.LATA5    </span><span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define BYPASS_LED          LATAbits.LATA4    </span><span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define BITBANG_PORT        LATEbits.LATE2    </span><span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define FREQ_PIN            PORTEbits.RE3     </span><span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define RADIO_OUT_PIN       LATAbits.LATA2    </span><span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>#define RELAY_BUS_PIN       LATEbits.LATE0    </span><span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define ANTENNA_RELAY       LATEbits.LATE1    </span><span style=color:#75715e>// 
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ADC Channel Select macros
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define ADC_FWD_PIN 0
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ADC_REV_PIN 1
</span></span></span></code></pre></td></tr></table></div></div><p>This is the matching initializing code, which sets up all the GPIOs in the correct modes: analog vs digital, input vs output. Notice that the pin names defined in the header can barely help us, because we need to access different registers for initialization than for reading/writing.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// hardware.c
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>ports_init</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Pin Analog select: 1 = analog, 0 = digital
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    ANSELA <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b00000011;
</span></span><span style=display:flex><span>    ANSELB <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b00000000;
</span></span><span style=display:flex><span>    ANSELC <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b00000000;
</span></span><span style=display:flex><span>    ANSELD <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b00000000;
</span></span><span style=display:flex><span>    ANSELE <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b00000000;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Pin Direction select: 1 = input, 0 = output
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISA <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b00000011; <span style=color:#75715e>// RA0 and RA1 inputs for FWD/REV
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISB <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b11111111; 
</span></span><span style=display:flex><span>    TRISC <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b11111111;
</span></span><span style=display:flex><span>    TRISD <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b00000000;
</span></span><span style=display:flex><span>    TRISE <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b00000000; <span style=color:#75715e>// Radio CMD and RelayBus are outs
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>startup</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>ports_init</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// INITIALIZATIONS
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    STROBE_PIN <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    CLOCK_PIN <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    RADIO_OUT_PIN <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>All in all, this isn&rsquo;t unreasonable. A lot of firmware like this exists. Handling one or two projects like this is perfectly manageable.</p><p>But what about five?</p><p>Ten? Twenty?</p><h2 id=story-time-scaling-with-the-status-quo>Story Time: Scaling with the status quo</h2><p>Imagine it&rsquo;s new product time: You get a schematic for the new board from the hardware team. You look it over and it&rsquo;s reasonably similar to one of the projects you&rsquo;ve already been working on. You do the obvious thing: fork the most similar project and start modifying it. Plug the new MCU pinout into <code>hardware.h</code> as pin definitions. Modify the <code>port_init()</code> function in <code>hardware.c</code>.</p><p>The code compiles. When the dev unit arrives, you upload your hex and the LEDs come on and the serial port chatters happily. Maybe there was some swearing, but overall you&rsquo;re satisfied, so you commit all your progress and start pulling datasheets for the other chips you&rsquo;re going to need to talk to.</p><p>Fast forward 3 weeks: it&rsquo;s time to sketch out the ADC driver for the new sensor module. Everything starts out okay, but quickly you notice that you&rsquo;re not getting the range of values you expect. You spend the afternoon tracing out the sensor circuit with your oscilloscope, but you can&rsquo;t find the cause. At five o&rsquo;clock you put away your probes and head home, frustrated that you haven&rsquo;t found the issue yet.</p><p>The next day you turn on your computer, open your editor, and your eyes catch on a line of code:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>ANSELA <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b00000011;
</span></span></code></pre></td></tr></table></div></div><p>Wait, <code>A0</code> and <code>A1</code>? This product moved one of the analog inputs to <code>A2</code>! Okay, easy fix:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>ANSELA <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>b00000110;
</span></span></code></pre></td></tr></table></div></div><p>A stupid typo. Annoyed, you recompile and upload the hex. Amazingly, the ADC works better when it&rsquo;s actually enabled in the GPIO registers.</p><h2 id=i-mean-its-one-typo-michael-what-could-it-cost>I mean, it&rsquo;s one typo, Michael. What could it cost?</h2><p>This is a true story. It&rsquo;s happened to me more times than I want to admit, and it&rsquo;s probably happened to you. In my experience, there are two reasons why this simple typo hits so hard:</p><h4 id=lack-of-a-single-source-of-truth>(Lack of a) Single Source of Truth</h4><p>In the original configuration example, changing something about a pin requires making changes in multiple places in multiple files. The changes also aren&rsquo;t all in a standardized format. Deciding to change a pin from a digital output to an analog input could easily require 5, 6, 7 edits. It&rsquo;s very difficult to <a href=https://www.joelonsoftware.com/2005/05/11/making-wrong-code-look-wrong/>make the wrong code look wrong</a> with this kind of setup.</p><h4 id=temporal-distance>Temporal Distance</h4><p>Unless you can test <em>every</em> subsystem in your processor in a single day, there&rsquo;s going to be some delay between when you do the inital setup and when you can start writing code that targets a given peripheral. This creates a gap between when the error happens and when it&rsquo;s possible to detect it. All the deep context from when you first wrote the setup code is gone, and your debugging efforts have to start from a blank page. In this situation, even simple typos can punch WAY above their weight.</p><h2 id=there-must-be-a-better-way>There Must be a Better Way!</h2><p>An ideal solution fixes the above problems, plus a few more:</p><ul><li>single source of truth</li><li>solve the temporal distance issue by making wrong configurations a compiler error</li><li>write as much of the configuration in one shot as possible</li><li>support multiple compilation profiles (dev/release)</li><li>good ergonomics</li><li>powerful, flexible, and extensible</li></ul><p>If we were writing C++, we could use templates and constexpr. Unfortunately, this project is restricted to C. The C preprocessor is deeply abusable, but even it&rsquo;s dark powers are limited.</p><p>What I eventually settled on was Python scripts as part of my toolchain, using a tool from Ned Batchelder called <a href=https://nedbatchelder.com/code/cog/>Cog</a>. Cog allows you to write Python directly in other source code, inside block comments. When you run cog on the combined source, it evaluates the contents of the cog block and inserts the output into the specified region.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/*[[[cog
</span></span></span><span style=display:flex><span><span style=color:#75715e>import cog # Cog actually imports this automatically!
</span></span></span><span style=display:flex><span><span style=color:#75715e>cog.outl(&#34;Hello world!&#34;) # cog.outl() inserts its output after the block
</span></span></span><span style=display:flex><span><span style=color:#75715e>]]]*/</span>
</span></span><span style=display:flex><span>Hello world<span style=color:#f92672>!</span>
</span></span><span style=display:flex><span><span style=color:#75715e>//[[[end]]]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/*[[[cog
</span></span></span><span style=display:flex><span><span style=color:#75715e>fnames = [&#39;DoSomething&#39;, &#39;DoAnotherThing&#39;, &#39;DoLastThing&#39;]
</span></span></span><span style=display:flex><span><span style=color:#75715e>for fn in fnames:
</span></span></span><span style=display:flex><span><span style=color:#75715e>    cog.outl(&#34;void %s();&#34; % fn)
</span></span></span><span style=display:flex><span><span style=color:#75715e>]]]*/</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>DoSomething</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>DoAnotherThing</span>();
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>DoLastThing</span>();
</span></span><span style=display:flex><span><span style=color:#75715e>//[[[end]]]
</span></span></span></code></pre></td></tr></table></div></div><p>Cog doesn&rsquo;t modify the file if the output hasn&rsquo;t changed, so it&rsquo;s <code>make</code> friendly. The generated code can be mixed with handwritten code, and is checked directly into version control, so it&rsquo;s explorable and discoverable, and your IDE/tools can navigate it directly.</p><h2 id=pin-definition-format>Pin Definition Format</h2><p>The following file is the custom format for pin definitions. It&rsquo;s designed to minimize write/edit friction and maximize reviewability. The intended usage is to reference the schematic, and match each pin on the schematic with its definition in the configuration. Any data entry errors should be trivially discoverable by stepping through the config line-by-line.</p><p>A pin is defined by 3 elements, a PIN_ID, a PIN_NAME, and a list of tags. The PIN_ID is the pin&rsquo;s identifier in the hardware/datasheet. The PIN_NAME should be human-readable, and is used to generate the macros and functions. The list of tags describes what features you want enabled on that pin.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#75715e># Pin definition format:</span>
</span></span><span style=display:flex><span><span style=color:#75715e># &#39;PIN_ID&#39;: (&#39;PIN_NAME&#39;, [&#39;list&#39;, &#39;of&#39;, &#39;tags&#39;])</span>
</span></span><span style=display:flex><span>common <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;A0&#39;</span>: <span style=color:#66d9ef>None</span>, <span style=color:#75715e># pins can be left undefined</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;A2&#39;</span>: (<span style=color:#e6db74>&#39;ONE_BUTTON_PIN&#39;</span>, [<span style=color:#e6db74>&#39;input&#39;</span>, <span style=color:#e6db74>&#39;gpio&#39;</span>, <span style=color:#e6db74>&#39;button&#39;</span>]),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;A7&#39;</span>: (<span style=color:#e6db74>&#39;RED_LED_PIN&#39;</span>, [<span style=color:#e6db74>&#39;output&#39;</span>, <span style=color:#e6db74>&#39;gpio&#39;</span>]),
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The <code>Pin</code> class is at the top of <code>pinmap.py</code>, and functions as both a reference for the available tags, as well as a helpful shortcut for commonly used tag groups.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Pin</span>:
</span></span><span style=display:flex><span>    <span style=color:#75715e># possible pin functions (this is just here for reference)</span>
</span></span><span style=display:flex><span>    tags <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;input&#39;</span>, <span style=color:#e6db74>&#39;output&#39;</span>, <span style=color:#75715e># initial pin direction</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;gpio&#39;</span>, <span style=color:#75715e># generate GPIO utility functions</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;tristate&#39;</span>, <span style=color:#75715e># pin direction will be changed at runtime</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;analog&#39;</span>, <span style=color:#75715e># generate ADC helpers</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;pullup&#39;</span>, <span style=color:#75715e># enable the pullup resistor</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;button&#39;</span>, <span style=color:#75715e># pin is used by the button debouncer</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;pps&#39;</span> <span style=color:#75715e># generate pin remapping helpers</span>
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># shortcuts, common groups of functions</span>
</span></span><span style=display:flex><span>    button <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;input&#39;</span>, <span style=color:#e6db74>&#39;gpio&#39;</span>, <span style=color:#e6db74>&#39;button&#39;</span>]
</span></span><span style=display:flex><span>    digital_out <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;output&#39;</span>, <span style=color:#e6db74>&#39;gpio&#39;</span>]
</span></span><span style=display:flex><span>    analog_in <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;input&#39;</span>, <span style=color:#e6db74>&#39;analog&#39;</span>]
</span></span><span style=display:flex><span>    uart_tx <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;output&#39;</span>, <span style=color:#e6db74>&#39;pps&#39;</span>]
</span></span><span style=display:flex><span>    uart_rx <span style=color:#f92672>=</span> [<span style=color:#e6db74>&#39;input&#39;</span>, <span style=color:#e6db74>&#39;pps&#39;</span>]
</span></span></code></pre></td></tr></table></div></div><p>Here&rsquo;s an example pinmap with a variety of features being used:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span><span style=color:#75715e># format: &#39;PIN_ID&#39;: (&#39;PIN_NAME&#39;, [&#39;list&#39;, &#39;of&#39;, &#39;tags&#39;])</span>
</span></span><span style=display:flex><span>common <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># Buttons</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;A2&#39;</span>: (<span style=color:#e6db74>&#39;ONE_BUTTON_PIN&#39;</span>, [<span style=color:#e6db74>&#39;input&#39;</span>, <span style=color:#e6db74>&#39;gpio&#39;</span>, <span style=color:#e6db74>&#39;button&#39;</span>]), <span style=color:#75715e># specify tags</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;A3&#39;</span>: (<span style=color:#e6db74>&#39;TWO_BUTTON_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>button), <span style=color:#75715e># or use the premade tag groups</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Individual LEDs</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;A5&#39;</span>: (<span style=color:#e6db74>&#39;GREEN_LED_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>digital_out),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;A6&#39;</span>: (<span style=color:#e6db74>&#39;YELLOW_LED_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>digital_out), 
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;A7&#39;</span>: (<span style=color:#e6db74>&#39;RED_LED_PIN&#39;</span>, [<span style=color:#e6db74>&#39;output&#39;</span>, <span style=color:#e6db74>&#39;gpio&#39;</span>]),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># Analog inputs</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;B0&#39;</span>: (<span style=color:#e6db74>&#39;KNOB_ONE_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>analog_in),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;B1&#39;</span>: (<span style=color:#e6db74>&#39;KNOB_TWO_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>analog_in),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LED Bargraph -bitbang SPI</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;C3&#39;</span>: (<span style=color:#e6db74>&#39;BARGRAPH_CLOCK_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>digital_out),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;C5&#39;</span>: (<span style=color:#e6db74>&#39;BARGRAPH_DATA_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>digital_out),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;E0&#39;</span>: (<span style=color:#e6db74>&#39;BARGRAPH_STROBE_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>digital_out),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># LCD - bitbang serial</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;D2&#39;</span>: (<span style=color:#e6db74>&#39;LCD_TX_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>digital_out),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># RGB LED - common cathode, active high</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;D5&#39;</span>: (<span style=color:#e6db74>&#39;RGB_1_LED_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>digital_out),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;D6&#39;</span>: (<span style=color:#e6db74>&#39;RGB_2_LED_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>digital_out),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;D7&#39;</span>: (<span style=color:#e6db74>&#39;RGB_3_LED_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>digital_out),
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># USB uart</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;F6&#39;</span>: (<span style=color:#e6db74>&#39;USB_TX_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>uart_tx),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;F7&#39;</span>: (<span style=color:#e6db74>&#39;USB_RX_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>uart_rx),
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The toolchain supports development and release builds, and the following two pin dictionaries are merged with the common dictionary to create the full configuration for each mode.</p><p>This allows for using different hardware for dev and release, driven by a single declarative configuration</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-py data-lang=py><span style=display:flex><span>development <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e># the debug serial port is only available on development builds</span>
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;B6&#39;</span>: (<span style=color:#e6db74>&#39;DEBUG_TX_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>uart_tx),
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;B7&#39;</span>: (<span style=color:#e6db74>&#39;DEBUG_RX_PIN&#39;</span>, Pin<span style=color:#f92672>.</span>uart_rx),
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>release <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><h2 id=generated-code>Generated Code</h2><p>Let&rsquo;s go over the generated <code>pin.h</code> section by section, starting with the Cog block that&rsquo;s doing all the work. This block is what&rsquo;s actually executed by running Cog, and it imports some python libraries that are tucked away in the toolchain directory (these will be explored at a later date).</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* [[[cog
</span></span></span><span style=display:flex><span><span style=color:#75715e>    from codegen import fmt; import pins
</span></span></span><span style=display:flex><span><span style=color:#75715e>    cog.outl(fmt(pins.pin_declarations()))
</span></span></span><span style=display:flex><span><span style=color:#75715e>]]] */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// &lt;generated code goes here&gt;
</span></span></span><span style=display:flex><span><span style=color:#75715e>// [[[end]]]
</span></span></span></code></pre></td></tr></table></div></div><p>Here&rsquo;s an easier to read version, if you prefer:</p><details><summary>Expand me</summary><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> codegen <span style=color:#f92672>import</span> fmt
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> pins
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> cog <span style=color:#75715e># im</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># parse pinmap.py and return a string containing the C code we want</span>
</span></span><span style=display:flex><span>raw_output <span style=color:#f92672>=</span> pins<span style=color:#f92672>.</span>pin_declarations()
</span></span><span style=display:flex><span><span style=color:#75715e># format the C code using clang-format so it matches the project</span>
</span></span><span style=display:flex><span>formatted_output <span style=color:#f92672>=</span> fmt(raw_output)
</span></span><span style=display:flex><span><span style=color:#75715e># insert the formatted code after the Cog block</span>
</span></span><span style=display:flex><span>cog<span style=color:#f92672>.</span>outl(formatted_output)
</span></span></code></pre></td></tr></table></div></div></details><h3 id=gpio-helper-functions>GPIO Helper Functions</h3><p>The next section is GPIO related utility functions. These functions use the human readable pin names, and are only created for pins that are marked as requiring specific functionality. This hides the details of which functions are on which pins from the rest of your application, and also tricks the compiler into helping detect configuration errors.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// GPIO read functions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>read_ONE_BUTTON_PIN</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>read_TWO_BUTTON_PIN</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GPIO write functions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_GREEN_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_YELLOW_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RED_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_BARGRAPH_CLOCK_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_BARGRAPH_DATA_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_LCD_TX_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RGB_1_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RGB_2_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RGB_3_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_BARGRAPH_STROBE_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GPIO direction functions
</span></span></span><span style=display:flex><span><span style=color:#75715e>// none
</span></span></span></code></pre></td></tr></table></div></div><h3 id=button-subsytem>Button Subsytem</h3><p>I use a standard button debouncing system in most of my projects, an evolution of <a href=https://hackaday.com/2015/12/09/embed-with-elliot-debounce-your-noisy-buttons-part-i/>this one</a> described by Elliot Williams at Hackaday. A 5ms timer triggers an interrupt service routine(ISR), which scans all the buttons in the system. The system tracks the recent history of each button, allowing it to ignore button noise and detect 4 distinct input states: UP, DOWN, PRESSED (rising edge), and RELEASED (falling edge).</p><p>The generated array <code>buttonFunctions</code> is used in the ISR to scan each button in a loop. The enum of the button names allows us to have a clean API for checking button state from application code: <code>is_btn_down(ONE)</code>, <code>is_btn_pressed(TWO)</code>, etc.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// Button stuff
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define NUMBER_OF_BUTTONS 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>bool</span> (<span style=color:#f92672>*</span><span style=color:#66d9ef>button_function_t</span>)(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// array of pointers to button reading functions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>button_function_t</span> buttonFunctions[NUMBER_OF_BUTTONS];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// enum of button names
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>enum</span> {
</span></span><span style=display:flex><span>    ONE,
</span></span><span style=display:flex><span>    TWO,
</span></span><span style=display:flex><span>} button_names;
</span></span></code></pre></td></tr></table></div></div><h3 id=pin-remapping>Pin Remapping</h3><p>This family of microcontrollers allows remapping internal peripherals to different pin using a module called the Peripheral Pin Select, or PPS. Using these helpers to initialize the PPS system ensures peripherals are always routed to the correct locations.</p><p>Also note the presence of <code>#ifdef DEVELOPMENT</code>, allowing the system to switch between development and release mode by simply adding or removing the <code>-DDEVELOPMENT</code> compiler flag.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// PPS Pin initialization macros
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define PPS_LCD_RX_PIN PPS_INPUT(D, 3)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define PPS_USB_TX_PIN PPS_OUTPUT(F, 6)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define PPS_USB_RX_PIN PPS_INPUT(F, 7)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#ifdef DEVELOPMENT
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define PPS_DEBUG_RX_PIN PPS_INPUT(B, 6)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e>#ifdef DEVELOPMENT
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define PPS_DEBUG_TX_PIN PPS_OUTPUT(B, 7)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span></code></pre></td></tr></table></div></div><h3 id=analog-helpers>Analog Helpers</h3><p>A numeric channel ID is required to initialize an ADC read, so generated helper macros make sure the correct channels are always being used.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>// ADC Channel Select macros
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define ADC_KNOB_ONE_PIN 8
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ADC_KNOB_TWO_PIN 9
</span></span></span></code></pre></td></tr></table></div></div><h3 id=full-generated-output>Full Generated Output</h3><p>The full header, if you want to see everything together:</p><details><summary>Expand me</summary><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* [[[cog
</span></span></span><span style=display:flex><span><span style=color:#75715e>    from codegen import fmt; import pins
</span></span></span><span style=display:flex><span><span style=color:#75715e>    cog.outl(fmt(pins.pin_declarations()))
</span></span></span><span style=display:flex><span><span style=color:#75715e>]]] */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GPIO read functions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>read_ONE_BUTTON_PIN</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>read_TWO_BUTTON_PIN</span>(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GPIO write functions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_GREEN_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_YELLOW_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RED_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_BARGRAPH_CLOCK_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_BARGRAPH_DATA_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_LCD_TX_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RGB_1_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RGB_2_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RGB_3_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_BARGRAPH_STROBE_PIN</span>(<span style=color:#66d9ef>bool</span> value);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GPIO direction functions
</span></span></span><span style=display:flex><span><span style=color:#75715e>// none
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* -------------------------------------------------------------------------- */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Button stuff
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define NUMBER_OF_BUTTONS 2
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// array of pointers to button reading functions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>typedef</span> <span style=color:#a6e22e>bool</span> (<span style=color:#f92672>*</span><span style=color:#66d9ef>button_function_t</span>)(<span style=color:#66d9ef>void</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>extern</span> <span style=color:#66d9ef>button_function_t</span> buttonFunctions[NUMBER_OF_BUTTONS];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// enum of button names
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>enum</span> {
</span></span><span style=display:flex><span>    ONE,
</span></span><span style=display:flex><span>    TWO,
</span></span><span style=display:flex><span>} button_names;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* -------------------------------------------------------------------------- */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// PPS Pin initialization macros
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define PPS_LCD_RX_PIN PPS_INPUT(D, 3)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define PPS_USB_TX_PIN PPS_OUTPUT(F, 6)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define PPS_USB_RX_PIN PPS_INPUT(F, 7)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#ifdef DEVELOPMENT
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define PPS_DEBUG_RX_PIN PPS_INPUT(B, 6)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e>#ifdef DEVELOPMENT
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define PPS_DEBUG_TX_PIN PPS_OUTPUT(B, 7)
</span></span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* -------------------------------------------------------------------------- */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ADC Channel Select macros
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#define ADC_KNOB_ONE_PIN 8
</span></span></span><span style=display:flex><span><span style=color:#75715e>#define ADC_KNOB_TWO_PIN 9
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// [[[end]]]
</span></span></span></code></pre></td></tr></table></div></div></details><p>And the full source file. It&rsquo;s essentially just the matching implementation of the header.</p><details><summary>Expand me</summary><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;pins.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>#include</span> <span style=color:#75715e>&#34;peripherals/pic_header.h&#34;</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* ************************************************************************** */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* [[[cog
</span></span></span><span style=display:flex><span><span style=color:#75715e>    from codegen import fmt; import pins
</span></span></span><span style=display:flex><span><span style=color:#75715e>    cog.outl(fmt(pins.pin_definitions()))
</span></span></span><span style=display:flex><span><span style=color:#75715e>]]] */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GPIO read functions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>read_ONE_BUTTON_PIN</span>(<span style=color:#66d9ef>void</span>) { <span style=color:#66d9ef>return</span> PORTAbits.RA2; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>bool</span> <span style=color:#a6e22e>read_TWO_BUTTON_PIN</span>(<span style=color:#66d9ef>void</span>) { <span style=color:#66d9ef>return</span> PORTAbits.RA3; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GPIO write functions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_GREEN_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATAbits.LATA5 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_YELLOW_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATAbits.LATA6 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RED_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATAbits.LATA7 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_BARGRAPH_CLOCK_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATCbits.LATC3 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_BARGRAPH_MISO_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATCbits.LATC4 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_BARGRAPH_DATA_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATCbits.LATC5 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_LCD_TX_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATDbits.LATD2 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RGB_1_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATDbits.LATD5 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RGB_2_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATDbits.LATD6 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_RGB_3_LED_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATDbits.LATD7 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>set_BARGRAPH_STROBE_PIN</span>(<span style=color:#66d9ef>bool</span> value) { LATEbits.LATE0 <span style=color:#f92672>=</span> value; }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// GPIO direction functions
</span></span></span><span style=display:flex><span><span style=color:#75715e>// none
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Button stuff
</span></span></span><span style=display:flex><span><span style=color:#75715e>// array of pointers to button reading functions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>button_function_t</span> buttonFunctions[NUMBER_OF_BUTTONS] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>    read_ONE_BUTTON_PIN, <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    read_TWO_BUTTON_PIN, <span style=color:#75715e>//
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// [[[end]]]
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* ************************************************************************** */</span>
</span></span><span style=display:flex><span><span style=color:#75715e>/* [[[cog
</span></span></span><span style=display:flex><span><span style=color:#75715e>    from codegen import fmt; import pins
</span></span></span><span style=display:flex><span><span style=color:#75715e>    cog.outl(fmt(pins.pins_init()))
</span></span></span><span style=display:flex><span><span style=color:#75715e>]]] */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>pins_init</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// ONE_BUTTON_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISAbits.TRISA2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    WPUAbits.WPUA2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// TWO_BUTTON_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISAbits.TRISA3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    WPUAbits.WPUA3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// GREEN_LED_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISAbits.TRISA5 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// YELLOW_LED_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISAbits.TRISA6 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// RED_LED_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISAbits.TRISA7 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// KNOB_ONE_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISBbits.TRISB0 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    ANSELBbits.ANSELB0 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// KNOB_TWO_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISBbits.TRISB1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>    ANSELBbits.ANSELB1 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// BARGRAPH_CLOCK_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISCbits.TRISC3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// BARGRAPH_MISO_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISCbits.TRISC4 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// BARGRAPH_DATA_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISCbits.TRISC5 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// LCD_TX_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISDbits.TRISD2 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// LCD_RX_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISDbits.TRISD3 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// RGB_1_LED_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISDbits.TRISD5 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// RGB_2_LED_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISDbits.TRISD6 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// RGB_3_LED_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISDbits.TRISD7 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// BARGRAPH_STROBE_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISEbits.TRISE0 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// USB_TX_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISFbits.TRISF6 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// USB_RX_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISFbits.TRISF7 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// DEBUG_RX_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#ifdef DEVELOPMENT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISBbits.TRISB6 <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span><span style=color:#75715e>// DEBUG_TX_PIN
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e>#ifdef DEVELOPMENT
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    TRISBbits.TRISB7 <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span><span style=color:#75715e>#endif
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// [[[end]]]
</span></span></span></code></pre></td></tr></table></div></div></details><h1 id=feature-overview-or-why-did-we-actually-do-all-this>Feature Overview, or: Why did we actually do all this?</h1><p>The implementation of the code generator is unremarkable(it&rsquo;s just strings in python), so we&rsquo;ll skip over that for now. Far more interesting is how many different firmware features are handled:</p><ul><li>function wrappers for all register access:<ul><li>GPIO read</li><li>GPIO write</li><li>GPIO direction set</li></ul></li><li>automatic port initializing, making sure every pin is configured correctly</li><li>Button debouncing subsystem configuration:<ul><li>total button count</li><li>an array of function pointers to the GPIO read function for each button</li><li>an enum of the button names</li></ul></li><li>Peripheral Pin Select (PPS) macros, used to remap features to different pins</li><li>ADC Channel select macros</li><li>Supports dev/release mode, using <code>DEVELOPMENT</code> macro</li><li>Automatically regenerated when <code>pinmap.py</code> is changed</li></ul><p>This code generation system was directly responsible for reducing new project setup time from days (and a long tail of errors that lasted weeks) to approximately 30 minutes. I was able to get a new schematic from the hardware team, clone the most similar existing project, and have the new project compiled, running on hardware and responding to serial comms in 30 minutes, with no configuration timebombs waiting to derail me a month down the road.</p></div></div><div class=post><div class=post-title><h1><a href=/posts/git_worktrees/>Git Worktrees: The Best Kept Git Secret?</a></h1><div class="meta post-footer">Oct 3 2022 09:29 UTC-04</div></div><div class=post-content><h2 id=whats-the-problem>What&rsquo;s the Problem?</h2><p>Git branches are a fact of life if you work on projects above a certain size: there&rsquo;s just no other (good) way to scale and coordinate effort from multiple programmers on one codebase. Unfortunately, mandatory doesn&rsquo;t mean <em>always</em> mean pleasant, and I&rsquo;m sure most of you have danced the Branch Shuffle enough times that you know exactly what I&rsquo;m talking about.</p><p>What if I told you there was a better way?</p><h2 id=enter-git-worktrees>Enter, Git Worktrees</h2><p>Git worktrees allow you to have as many branches as you want checked out at the same time. Each branch can be staged, pushed, pulled, and reverted independently. Checking out a new branch is a single command and doesn&rsquo;t disturb your existing branches, so there&rsquo;s no need to hurridly commit your in-progress work or stash your working set with a non-descriptive name when you recieve that Priority 1++++ bug report in the middle of lunch.</p><h2 id=okay-but-how-does-it-work>Okay, But How Does It Work?</h2><p>I was deeply surprised at how easy it was to set up. Here&rsquo;s my recommendation:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>mkdir MyProject <span style=color:#f92672>&amp;&amp;</span> cd MyProject
</span></span><span style=display:flex><span>git clone --bare https://url.com/path/to/MyProject .bare
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;gitdir: ./.bare&#34;</span>&gt; .git
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>git worktree add master
</span></span><span style=display:flex><span>git worktree add other_branch
</span></span></code></pre></td></tr></table></div></div><p>A normal clone operation will produce a folder that looks like this:</p><pre tabindex=0><code>MyProject
â”œâ”€â”€ .git
â”‚   â””â”€â”€ &lt;git config folder contents&gt;
â”œâ”€â”€ other_file.txt
â””â”€â”€ readme.md
</code></pre><p>The above procedure will produce this instead:</p><pre tabindex=0><code>MyProject
â”œâ”€â”€ .bare
â”‚   â””â”€â”€ &lt;git config folder contents&gt;
â”œâ”€â”€ master
â”‚   â”œâ”€â”€ other_file.txt
â”‚   â””â”€â”€ readme.md
â”œâ”€â”€ other_branch
â”‚   â”œâ”€â”€ other_file.txt
â”‚   â”œâ”€â”€ new_file.txt
â”‚   â””â”€â”€ readme.md
â””â”€â”€ .git // file, not folder
</code></pre><p>As promised, each branch is checked out into it&rsquo;s own folder. The <code>.git</code> file is necessary because without it and the extra argument to clone into <code>./.bare</code> , the git config folder will just be dumped into the project root. I don&rsquo;t know why this is the default operating mode of worktrees but I find it revolting.</p><p>The contents of <code>.git</code> simply tell the git executable that the actual git config folder is in <code>./.bare</code> instead of the usual <code>./.git</code>.</p><h2 id=now-what>Now what?</h2><p>Personally I open the individual branch folders with VSCode and proceed as usual, but if you like workspace files you could set up a multi-root workspace to open all the branches at once or whatever you want.</p><h2 id=references>References</h2><p>Actual documentation:</p><p><a href=https://git-scm.com/docs/git-worktree>https://git-scm.com/docs/git-worktree</a></p><p>Inspired by ThePrimagen&rsquo;s YouTube video &ldquo;Git&rsquo;s Best and Most Unknown Feature&rdquo;:</p><p><a href="https://www.youtube.com/watch?v=2uEqYw-N8uE">https://www.youtube.com/watch?v=2uEqYw-N8uE</a></p><p>Refined with ideas from Morgan Cugerone:</p><p><a href=https://morgan.cugerone.com/blog/how-to-use-git-worktree-and-in-a-clean-way/>https://morgan.cugerone.com/blog/how-to-use-git-worktree-and-in-a-clean-way/</a></p><p><a href=https://morgan.cugerone.com/blog/workarounds-to-git-worktree-using-bare-repository-and-cannot-fetch-remote-branches/>https://morgan.cugerone.com/blog/workarounds-to-git-worktree-using-bare-repository-and-cannot-fetch-remote-branches/</a></p></div></div><div class=post><div class=post-title><h1><a href=/posts/godot_layout_helpers/>Godot Layout Helpers: Additional Exercises in Pain Reduction</a></h1><div class="meta post-footer">Oct 3 2022 08:43 UTC-04</div></div><div class=post-content><h1 id=the-setup>The setup</h1><p>Creating UI layouts in GDScript is annoying, but it doesn&rsquo;t have to be. Let&rsquo;s explore:</p><p>Consider the following snippet, that creates a dialog box, a vertical box layout, and a Label and ProgressBar.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span><span style=color:#66d9ef>var</span> update_dialog <span style=color:#f92672>=</span> <span style=color:#a6e22e>AcceptDialog</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> vbox <span style=color:#f92672>=</span> <span style=color:#a6e22e>VBoxContainer</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span>update_dialog<span style=color:#f92672>.</span>add_child(vbox)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> status_label <span style=color:#f92672>=</span> <span style=color:#a6e22e>Label</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span>vbox<span style=color:#f92672>.</span>add_child(status_label)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> progress_bar <span style=color:#f92672>=</span> <span style=color:#a6e22e>ProgressBar</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span>vbox<span style=color:#f92672>.</span>add_child(progress_bar)
</span></span></code></pre></td></tr></table></div></div><p>This is unpleasant for a number of reasons, but the most important one is that you can&rsquo;t just read it from top to bottom. Every other line diverts your attention back up the page. Nearly as bad, almost half the lines are just layout boilerplate, and don&rsquo;t really say anything valuable.</p><p>Simply put, the signal-to-noise ratio of this 7 line snippet is awful.</p><h1 id=can-we-do-better>Can we do better?</h1><p>Obviously yes(why else would this post exist?).</p><p>This snippet uses a helper class to simplify the layout code, reduce boilerplate, and prevent your flow from being interrupted by removing most of the backtracking. This version can be read from top to bottom in one shot.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span><span style=color:#66d9ef>var</span> update_dialog <span style=color:#f92672>=</span> <span style=color:#a6e22e>AcceptDialog</span><span style=color:#f92672>.</span>new()
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> vbox <span style=color:#f92672>=</span> VBox<span style=color:#f92672>.</span>new(update_dialog)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> status_label <span style=color:#f92672>=</span> vbox<span style=color:#f92672>.</span>add(<span style=color:#a6e22e>Label</span><span style=color:#f92672>.</span>new())
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> progress_bar <span style=color:#f92672>=</span> vbox<span style=color:#f92672>.</span>add(<span style=color:#a6e22e>ProgressBar</span><span style=color:#f92672>.</span>new())
</span></span></code></pre></td></tr></table></div></div><h1 id=the-explanation>The explanation</h1><p>This class is 7 lines long, do I really need to explain it?</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-gdscript data-lang=gdscript><span style=display:flex><span><span style=color:#66d9ef>class</span> VBox <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>VBoxContainer</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> _init(parent<span style=color:#f92672>=</span>null):
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> parent:
</span></span><span style=display:flex><span>            parent<span style=color:#f92672>.</span>add_child(self)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span> add(object):
</span></span><span style=display:flex><span>        add_child(object)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> object
</span></span></code></pre></td></tr></table></div></div><p>Okay, fine, there are some subtleties:</p><ul><li>This is a <code>class</code>, intended to be copied into some other script. I did this to avoid polluting the global class namespace and creating changes in <code>project.godot</code>.</li><li>The name <code>VBox</code> was chosen because it&rsquo;s shorter and thus produces shorter code.</li><li>The <code>_init()</code> method&rsquo;s <code>parent</code> argument is optional, so you can still use it the normal way.</li></ul><p>(Do I have to point out that if you want the horizontal version, just change two <code>V</code>s to <code>H</code>s?)</p></div></div><div class=post><div class=post-title><h1><a href=/posts/godot_editor_settings/>Godot Editor Settings and You: An Exercise in Pain Reduction</a></h1><div class="meta post-footer">Sep 27 2022 10:21 UTC-04</div></div><div class=post-content><p>The Godot editor has a number of absolutely boneheaded default settings. Here&rsquo;s my recommendations for a better overall experience:</p><p><del>Step one: Use an external text editor</del></p><p>This just saves space:</p><pre tabindex=0><code class=language-gdresource data-lang=gdresource>interface/inspector/horizontal_vector2_editing = true
</code></pre><p>I often work on plugins, which means restarting the editor all time. This makes restarting suck less.</p><pre tabindex=0><code class=language-gdresource data-lang=gdresource>interface/scene_tabs/restore_scenes_on_load = true
</code></pre><p>These prevent the internal script editor from building a collection of every single script in your project:</p><pre tabindex=0><code class=language-gdresource data-lang=gdresource>text_editor/files/open_dominant_script_on_scene_change = false
text_editor/files/restore_scripts_on_load = false
</code></pre><p>This makes the editor (attempt) to reload things like tool and plugin scripts when you change them in a real text editor.</p><pre tabindex=0><code class=language-gdresource data-lang=gdresource>text_editor/files/auto_reload_scripts_on_external_change = true
</code></pre><p>These stop the blasted thing from opening the internal script editor when there&rsquo;s an error:</p><pre tabindex=0><code class=language-gdresource data-lang=gdresource>text_editor/external/use_external_editor = true
text_editor/external/exec_path = &#34;&#34;
text_editor/external/exec_flags = &#34;&#34;
</code></pre><p>These apply to LSP completions when using an external editor:</p><pre tabindex=0><code class=language-gdresource data-lang=gdresource>text_editor/completion/add_type_hints = true
text_editor/completion/use_single_quotes = true
</code></pre><p>These improve the LSP experience a little bit:</p><pre tabindex=0><code class=language-gdresource data-lang=gdresource>network/language_server/show_native_symbols_in_editor = true
network/language_server/use_thread = true
</code></pre></div></div><div class=post><div class=post-title><h1><a href=/posts/vscode_extensions/>Adventures in VSCode Extensions</a></h1><div class="meta post-footer">Sep 8 2022 07:59 UTC-04</div></div><div class=post-content><p>The scope tags (&ldquo;name&rdquo;) applied by a match are actually a space-separated list of tags. Multiple tags can be added by a single rule. This fact can be used for debugging by adding extra tags to a rule to make sure it&rsquo;s being applied properly.</p><pre tabindex=0><code>markup.italic
markup.bold
</code></pre><p>A collection of resources for building VSCode extensions:</p><p><a href=https://github.com/RedCMD/TmLanguage-Syntax-Highlighter>https://github.com/RedCMD/TmLanguage-Syntax-Highlighter</a></p><p><del><a href="https://marketplace.visualstudio.com/items?itemName=pedro-w.tmlanguage">https://marketplace.visualstudio.com/items?itemName=pedro-w.tmlanguage</a></del></p><p><a href=https://www.apeth.com/nonblog/stories/textmatebundle.html>https://www.apeth.com/nonblog/stories/textmatebundle.html</a></p><p><a href=https://code.visualstudio.com/api/references/vscode-api>https://code.visualstudio.com/api/references/vscode-api</a></p><p><a href=https://www.nicoespeon.com/en/2019/11/fix-vscode-extension-performance-issue/>https://www.nicoespeon.com/en/2019/11/fix-vscode-extension-performance-issue/</a></p><p><a href=https://code.visualstudio.com/api/extension-capabilities/common-capabilities>https://code.visualstudio.com/api/extension-capabilities/common-capabilities</a></p><p><a href=https://snyk.io/blog/vs-code-extension-building-auto-cicd-with-github-actions/>https://snyk.io/blog/vs-code-extension-building-auto-cicd-with-github-actions/</a></p></div></div><div class=post><div class=post-title><h1><a href=/posts/first_steps/>First Steps For New Firmware</a></h1><div class="meta post-footer">Apr 13 2021 03:53 UTC-04</div></div><div class=post-content><p>It&rsquo;s always useful to have a concrete, achievable goal. When working on embedded systems, especially starting a new project, there&rsquo;s so many things to do that it&rsquo;s easy to get overwhelmed by decision paralysis. Imagine you just got the first prototype of a new board. You don&rsquo;t have any code for it yet. Where do you start?</p><h1 id=blink-an-led>Blink An LED</h1><p>Hopefully your hardware has an LED tied to a microcontroller pin. Assuming it does, the first real goal of the project is to turn that LED on.</p><p>I know it sounds trivial, but getting an LED blinking program to run on your hardware actually contains a bunch of non-trivial accomplishments:</p><ul><li>the compiler has to installed correctly</li><li>the toolchain has to be able to see your project files and invoke the compiler</li><li>the programmer has to exist</li><li>the programmer&rsquo;s drivers have to be installed correctly</li><li>the programmer&rsquo;s control software has to be installed correctly</li><li>the toolchain has to be able to invoke the programmer</li><li>the board has to not explode when you plug in power</li><li>the board has to provide power to the processor</li><li>the board&rsquo;s in circuit programming has to be designed correctly</li><li>the board has to be connected to the programmer</li><li>the programmer has to be connected to the computer</li><li>the processor isn&rsquo;t dead</li><li>the processor boots</li><li>the processor boots and then loads the program you uploaded to it</li></ul><p>I could go on, but hopefully you get the point. Just compiling and uploading a program requires a long list of steps to all go properly, and you should never overlook how complicated this process actually is. Ideally, you should have a toolchain that allows single click or single command compilation and programming of your hardware.</p><p>My open source PIC18 toolchain, <a href=https://github.com/DaelonSuzuka/Easy-XC8>EasyXC8</a>, uses a Makefile with the commands <code>compile</code> and <code>upload</code>. Just running <code>make upload</code> will cause a new hex to be compiled(if necessary), and then the upload that new hex to the hardware using the specified programmer. I&rsquo;m not telling you to use EasyXC8, but if uploading firmware to your board is harder than <code>make upload</code>, there&rsquo;s something wrong with your workflow.</p><h1 id=timing-is-everything>Timing Is Everything</h1><p>Blinking an LED proved that your environment works, and that your processor will boot and run <em>something</em>.</p><p>The next goal is making sure that the something happens when we want it to. Let&rsquo;s set a modest objective: instead of just turning an LED on, let&rsquo;s make that LED blink on and off once per second:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>set_led</span>(<span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>delay_ms</span>(<span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>set_led</span>(<span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>delay_ms</span>(<span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>While it&rsquo;s usually unwise to use blocking delay functions like these, writing this little delay library will be a useful exercise in getting familiar with your hardware.</p><p>This is a &ldquo;simple&rdquo; implentation of delay_ms():</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delay_init</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timer2_clock_source</span>(TMR2_CLK_FOSC4);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timer2_postscale</span>(TMR_POSTSCALE_10);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timer2_prescale</span>(TMR_PRESCALE_16);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timer2_period_set</span>(<span style=color:#ae81ff>100</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timer2_start</span>();
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>delay_ms</span>(<span style=color:#66d9ef>uint16_t</span> milliSeconds) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (milliSeconds<span style=color:#f92672>--</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timer2_interrupt_flag_clear</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>while</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>timer2_interrupt_flag_read</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>This is a deceptively difficult task, because everything about it depends on your specific circumstances. This example is written for a <a href=https://www.microchip.com/wwwproducts/en/PIC18F57Q43>PIC18F57Q43</a> running at 64MHz. This processor has 7 timers, of which I&rsquo;ve chosen timer 2, an 8bit period match timer with a configurable period. I picked this timer because I can start it once and leave it running, and because it automatically resets the counter when it reaches the selected period value. These features make the delay_ms function simpler.</p><p>The postscale, prescale, and period were calculated starting from the main system clock value of 64MHz. In PICs, the main clock is known as FOSC. The selected clock source of <code>TMR2_CLK_FOSC4</code> is the FOSC divided by 4, or 16MHz. At 16MHz, one clock tick is 62.5nS long.</p><p>A single millisecond is equivalent to 1000 microseconds, or 1,000,000 nanoseconds. Dividing 1mS by 62.5nS gives us 16,000, the number of clock ticks in a millisecond. An 8bit timer can&rsquo;t count to 16,000, so we use the prescale to divide by 16, and the postscale to divide by 10, leaving us with a nice target of 100 timer ticks. With the period set to 100, the timer will now overflow every 1 millisecond, and set its interrupt flag.</p><p>The while loop inside delay_ms() only does two things: clear the interrupt flag, and wait for the flag to be set again. Each time through the loop is supposed to be 1mS, and the loop executes once per millisecond we want to delay.</p><p>You can use an oscilloscope on the LED to test that your delays are delaying for the right amount of time. Test multiple delay values. If the delay is too long or too short, the timer configuration can be adjusted to bring it in line.</p><p>Now, the details of this section will be irrelevant to you(unless you&rsquo;re using a PIC18 running at 64MHz), but the goal is a universal one: making sure your processor is running at the right speed. If you don&rsquo;t make a concious effort to prove that the clock is set properly, and have a way to PROVE that it&rsquo;s set properly(by measuring your 1000mS delay with a scope, for instance), then you&rsquo;re setting yourself up for failure before you&rsquo;ve even started.</p><h1 id=say-hello>Say Hello</h1><p>Once your processor is running and you trust that the clocks are right, your next goal is to set up a UART for serial debugging. Native serial ports on computers are quite rare now, so you&rsquo;ll probably need some kind of USB->UART cable. I recommend spending the money for a cable that has a genuine FTDI converter chip, it&rsquo;ll pay off in terms of reliability and driver support.</p><p>I like to define at least two functions: <code>uart_tx_char</code> and <code>uart_tx_string</code></p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>uart_tx_char</span>(<span style=color:#66d9ef>char</span> c) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// send a single byte to your UART peripheral here
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>uart_tx_string</span>(<span style=color:#66d9ef>const</span> <span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>string) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>uint8_t</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span> (string[i]) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>uart_tx_char</span>(string[i<span style=color:#f92672>++</span>]);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>main</span>(<span style=color:#66d9ef>void</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>while</span>(<span style=color:#ae81ff>1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>uart_tx_string</span>(<span style=color:#e6db74>&#34;beep</span><span style=color:#ae81ff>\r\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>delay_ms</span>(<span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div></div></div><div class=post><div class=post-title><h1><a href=/posts/key_management/>Towards An O(1) Solution For Key Management</a></h1><div class="meta post-footer">Mar 8 2021 08:43 UTC-05</div></div><div class=post-content><p>I&rsquo;m trying to optimize the following scenario:
I have 2 development machines. Each one has a keypair.
There are 10 remote hosts that I want to SSH into from any of the dev machines. Password authentication is disabled. I do not have physical access to all of the remote hosts.
I have created a 3rd dev machine, and I need to be able to SSH into any of hosts.</p><h2 id=solution-1>Solution #1:</h2><ul><li>get on one of the original dev machines</li><li>SSH into the a remote host</li><li>enable password auth</li><li>go back to the new dev machine</li><li>run <code>ssh-copy-id &lt;remote host></code></li><li>go back to original dev machine</li><li>disable password auth</li><li>repeat for every remote host</li></ul><p>This is terrible. It&rsquo;s a ton of manual work, I&rsquo;m intentionally creating a big security hole, and I&rsquo;m probably gonna forget to resecure some of my remote machines.</p><h2 id=solution-2>Solution #2:</h2><ul><li>make sure the new machine&rsquo;s public key is uploaded to my GitHub account</li><li>get on one of the original dev machines</li><li>SSH into the a remote host</li><li>run <code>ssh-import-id gh:&lt;username></code></li><li>repeat for every remote host</li></ul><p>Better. This is O(2n), where the 1st solution was O(10), and I can&rsquo;t forget to resecure the remote hosts.</p><p>Unfortunately this still requires going to back to one of the original machines, and it still requires two manual actions per remote host. If I forget to update one of the hosts, take my new dev machine out of the house, and then need to get into that particular host, I&rsquo;m SOL.</p><h2 id=solution-3>Solution #3:</h2><ul><li>make sure all the remote hosts are listed in an ansible inventory file</li><li>make sure the new machine&rsquo;s public key is uploaded to my GitHub account</li><li>get on one of the original dev machines</li><li>run <code>ansible all -i hosts -a "ssh-import-id gh:&lt;username>"</code></li></ul><p>Even more better. Now I&rsquo;m down to a constant time solution, assuming I have access to an original dev machine.</p><p>This is how I&rsquo;m currently managing this problem, except I put the ansible command in a shell script called <code>keypush.sh</code>. I expect this will scale quite well for my immediate needs.</p></div></div><div class=post><div class=post-title><h1><a href=/posts/mbp/>Care and Feeding of a mid-2012 MacBook Pro</a></h1><div class="meta post-footer">Feb 13 2021 01:52 UTC-05</div></div><div class=post-content><p>A friend recently gave me his old mid-2012 13" MacBook Pro. He has a newer MacBook Air now, and no longer needed his older Pro. He warned me that it had become exceedingly slow, but otherwise had no problems.</p><p>For the past several years, my primary machines have been a desktop and a Surface Pro 5. While the Surface is great, and I recommend it if you have any use at all for a pen (drawing, OneNote, whiteboarding), it&rsquo;s definitely a tablet and not a laptop. It&rsquo;s a tablet that tries, I have to give it that, but the kickstand is not a replacement for a hinge. Typing on a Surface in bed is an exercise in pain. Using it in the car or on the couch are barely any better.</p><p>Long story short, it&rsquo;s exciting to have a usable daily driver laptop for the first time in about five years.</p><p>Being a Windows guy and being spoiled by solid state drives, the first order of business was to pull the 5400rpm spinning rust HDD and replace with an SSD. My last spare SSD had been installed in some Thinkpad and had Windows already installed. On a whim, I decided to throw the drive into the MBP without reimaging it. I did not expect it to work, but 4 restarts later, Windows seemed to have properly reconfigured itself for it&rsquo;s new home. The keyboard was still missing it&rsquo;s function keys, trackpad multitouch was entirely missing, and wifi could see my SSID but refused to actually connect.</p><p>Thankfully, ethernet was fully operational, so I could start the search for drivers. Apple really, <strong>really</strong> wants you to install Bootcamp on your MacOS partition, and use that to download the Windows driver packages onto a flash drive. That&rsquo;s great unless you&rsquo;re a guy with no MacOS partition. It took two days to find a download link for the Windows files, but <a href="https://support.apple.com/kb/DL1720?locale=en_US">here it is</a>. I did find a newer download link, but those drivers didn&rsquo;t fix the wifi, so I kept going until I found 5.1.5621, which fixed the wifi and keyboard.</p><p>The trackpad still didn&rsquo;t work until I installed <a href=https://github.com/imbushuo/mac-precision-touchpad>this</a> third party touchpad driver. With that, 2, 3, and 4 finger multitouch all work properly in Windows.</p></div></div><div class=post><div class=post-title><h1><a href=/posts/hello/>Hello</a></h1><div class="meta post-footer">Feb 11 2021 04:28 UTC-05</div></div><div class=post-content><p>Hello blog.</p><p>After years of waffling and procrastination, I&rsquo;ve finally managed to put together a blog platform that doesn&rsquo;t feel like chewing on broken glass. Hugo seems to strike a good balance between flexible, powerful, simple, and extensible.</p><p>One less excuse to avoid putting thought to pixel.</p></div></div></div></div></div><footer><div class=footer-content><div class=contact-info><a href=https://github.com/DaelonSuzuka><img src="https://img.shields.io/badge/DaelonSuzuka-2ea44f?logo=github" alt=DaelonSuzuka></a></div><div class=contact-info><a href=https://ko-fi.com/daelon><img src="https://img.shields.io/badge/daelon-blue?logo=kofi" alt=daelon></a></div><div class=contact-info><a href=https://daelon.itch.io/><img src="https://img.shields.io/badge/daelon-gray?logo=itch.io" alt=daelon></a></div><div class=contact-info><a href=https://www.linkedin.com/in/daelonsuzuka/><img src="https://img.shields.io/badge/David_Kincaid-blue?logo=linkedin" alt="David Kincaid"></a></div></div></footer></main></body><script src=https://daelon.net/js/navbutton.js></script></html>